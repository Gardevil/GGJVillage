using UnityEngine;
using System.Collections;

public abstract class ExploitResurceAction : BaseAction
{
    protected int tripsLeft;
    protected float speed = 3;///m/s
    protected float exploitTimeMax = 5;///segundos
    protected float exploitTimeActual;
    protected bool goingToExploit;///controla si está yendo al recurso o trayéndolo al tótem
    protected Resource resource; ///recurso a explotar

    public override void Initialize()
    {
        tripsLeft = repetitions;
        exploitTimeActual = exploitTimeMax;
        goingToExploit = true;
        resource = GetClosestResource();
        if (resource == null)
        {
            Finish();
        }
        else
        {
            resource.inUse = true;
            villager.moveTo(resource.gameObject);
        }
    }

    protected abstract Resource GetClosestResource();

    public override void Update()
    {
        if (goingToExploit)
        {
            /// si ya ha llegado a la posición del árbol
            if (villager.standing)
            {
                exploitTimeActual -= Time.deltaTime;
                if (exploitTimeActual <= 0)
                {
                    exploitTimeActual = exploitTimeMax;
                    goingToExploit = false;
                    villager.moveToWareHouse();
                }
            }
        }
        else
        {
            /// si ya ha llegado al almacén
            if (villager.standing)
            {
                tripsLeft--;
                if (tripsLeft > 0)
                {
                    goingToExploit = true;
                    villager.moveTo(resource.gameObject);
                }
            }
        }
    }

    protected override void Finishing()
    {
        /// se pone como la vuelta de cortar el arbol del último viaje
        tripsLeft = 1;
        goingToExploit = false; 
        if (resource != null)
        {
            resource.inUse = false;
        }
    }

    public override bool IsFinished()
    {
        return tripsLeft == 0;
    }
}
